name: Terraform Pipeline

on:
  workflow_dispatch:
    inputs:
      resource_group_name:
        description: "Resource Group Name"
        required: false
        type: string
      key_vault_name:
        description: "Key Vault Name"
        required: false
        type: string
      key_name:
        description: "Key Name to create"
        required: false
        type: string
      secret_name:
        description: "Secret Name to create"
        required: false
        type: string

permissions:
  contents: read

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    outputs:
      rg: ${{ steps.capture.outputs.rg }}
      kv: ${{ steps.capture.outputs.kv }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          auth-type: SERVICE_PRINCIPAL

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: terraform-bootstrap
        run: terraform init

      - name: Create tfvars
        working-directory: terraform-bootstrap
        run: |
          cat << EOF > tf.auto.tfvars
          client_id="${{ secrets.AZURE_CLIENT_ID }}"
          client_secret="${{ secrets.AZURE_CLIENT_SECRET }}"
          tenant_id="${{ secrets.AZURE_TENANT_ID }}"
          subscription_id="${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          resource_group_name="${{ github.event.inputs.resource_group_name }}"
          key_vault_name="${{ github.event.inputs.key_vault_name }}"
          EOF

      - name: Terraform Apply
        working-directory: terraform-bootstrap
        run: terraform apply -auto-approve

      - name: Capture Outputs
        id: capture
        working-directory: terraform-bootstrap
        run: |
          echo "rg=$(terraform output -raw resource_group_name)" >> $GITHUB_OUTPUT
          echo "kv=$(terraform output -raw key_vault_name)" >> $GITHUB_OUTPUT

  provisioner:
    runs-on: ubuntu-latest
    needs: bootstrap

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          auth-type: SERVICE_PRINCIPAL

      - name: Install Az Module
        shell: pwsh
        run: Install-Module -Name Az -Force -Scope CurrentUser -AllowClobber

      - name: Run Provisioning (single line)
        shell: pwsh
        run: $rg="${{ github.event.inputs.resource_group_name }}".Trim();if(!$rg){$rg="${{ needs.bootstrap.outputs.rg }}".Trim()};$kv="${{ github.event.inputs.key_vault_name }}".Trim();if(!$kv){$kv="${{ needs.bootstrap.outputs.kv }}".Trim()};$key="${{ github.event.inputs.key_name }}".Trim();if(!$key){$key="app-key"};$secret="${{ github.event.inputs.secret_name }}".Trim();if(!$secret){$secret="app-secret"};$env:AZURE_CLIENT_ID="${{ secrets.AZURE_CLIENT_ID }}";$env:AZURE_CLIENT_SECRET="${{ secrets.AZURE_CLIENT_SECRET }}";$env:AZURE_TENANT_ID="${{ secrets.AZURE_TENANT_ID }}";$env:AZURE_SUBSCRIPTION_ID="${{ secrets.AZURE_SUBSCRIPTION_ID }}";./scripts/provision.ps1 -ResourceGroupName $rg -KeyVaultName $kv -AppObjectId "${{ secrets.APP_OBJECT_ID }}" -KeyName $key -SecretName $secret
